!function(a){function b(a,b,c){var d=b-b%a,e=b+c;a>9e5&&(d-=36e5);for(var f=[d];e>d;)d+=a,d>=b&&e>=d&&f.push(d);return f.length>20&&(f=f.slice(0,20)),f}var c=1e4,d=31536e8,e=function(b,c){return this.settings=a.extend({onhover:function(a,b,c,d){},onclick:function(a,b,c){},oncreate:function(a,b){},data:[],hammertime:!1,items_height:101,markers_height:31},c),this.element=b,this.width=b.width(),this.items_h=this.settings.items_height,this.markers_h=this.settings.markers_height,this._dragging=null,this._drag_x=0,b.addClass("eventcontrol"),b.append(['<div class="ec-items ec-draggable" style="top:0px;height:',this.items_h,'px;"></div>','<div class="ec-markers ec-draggable" style="top:',this.items_h+1,"px;height:",this.markers_h,'px;">','<div class="ec-ticks"></div>','<div class="ec-labels"></div>',"</div>"].join("")),this.items=b.children(".ec-items"),this.markers=b.children(".ec-markers"),this.ticks=this.markers.children(".ec-ticks"),this.labels=this.markers.children(".ec-labels"),this.min_time=moment("2070-01-01"),this.max_time=moment("1970-01-01"),this.timespan=d,this.max_timespan=d,this.center_time=this.min_time.valueOf()+.5*d,this.init(),this};e.prototype.init=function(){function d(a,c,d){a>.9?a=.9:-.9>a&&(a=-.9);var e=a*b.timespan,f=moment(c+e),g=moment(d+e);(!f.isSame(b.min_time)||g.isSame(b.max_time))&&b.update_timespan(f,g)}function e(){c.children(".ec-draggable").removeClass("ec-dragging"),b._dragging=null}var b=this,c=this.element;b.settings.hammertime?(b.mc=new Hammer.Manager(b.element.get()[0]),b.mc.add(new Hammer.Pan),b.mc.add(new Hammer.Tap({event:"doubletap",taps:2})),b.mc.add(new Hammer.Tap({event:"singletap"})),b.mc.get("doubletap").recognizeWith("singletap"),b.mc.get("singletap").requireFailure("doubletap"),b.mc.on("panstart panleft panright singletap doubletap tap",function(e){if("singletap"==e.type){var f=a(e.target);f.hasClass("ec-dot")&&b.settings.onclick.call(b,f.data("event"),f,e)}else if("panstart"==e.type)b._pan_min_time=b.min_time.valueOf(),b._pan_max_time=b.max_time.valueOf();else if("panleft"==e.type||"panright"==e.type){var g=-e.deltaX,h=g/b.width;d(h,b._pan_min_time,b._pan_max_time)}else if("doubletap"==e.type){var i=c.offset(),j=1,k=(e.center.x-i.left)/b.width;b.zoom(j,k)}else console.log("Unexpected hammer event",e.type)})):(c.on("click",function(c){var d=a(c.target);d.hasClass("ec-dot")&&b.settings.onclick.call(b,d.data("event"),d,c)}),c.mousedown(function(a){return 1==a.which?(c.children(".ec-draggable").addClass("ec-dragging"),b._dragging=!0,b._drag_x=a.pageX,b._drag_min_time=b.min_time.valueOf(),b._drag_max_time=b.max_time.valueOf(),!1):void 0}),a("body").mouseup(function(a){1==a.which&&e()}),a("body").on("dragend",function(){e()}),a("body").mousemove(function(a){if(1==a.which&&b._dragging){var c=-(a.pageX-b._drag_x),e=c/b.width;d(e,b._drag_min_time,b.drag_max_time)}})),a(window).resize(function(){b._dirty||(b._dirty=!0,b.min_time&&b.max_time&&window.setTimeout(function(){var a=b.min_time.clone(),c=b.max_time.clone();b.update_timespan(a,c)},400))}),c.on("mousewheel",function(a){a.preventDefault();var d=a.deltaY,e=c.offset(),f=(a.pageX-e.left)/b.width;b.zoom(d,f)}),a.each(b.settings.data,function(a,c){b.items.append('<div class="ec-dot" style="left:0px;top:0px;"></div>');var d=b.items.children(".ec-dot:last-child");d.data("event",c),c._starttime=moment(c.timestamp).valueOf(),b.settings.oncreate.call(b,c,d),d.hover(function(a){b.settings.onhover.call(b,c,d,a,"in")},function(a){b.settings.onhover.call(b,c,d,a,"out")});var e=moment(c.timestamp);e<b.min_time&&(b.min_time=e.clone()),e>b.max_time&&(b.max_time=e)}),b.min_time.subtract(5,"seconds"),b.max_time.add(5,"seconds"),b.center_time=b.min_time.valueOf()+.5*(b.max_time.valueOf()-b.min_time.valueOf()),b.update_timespan(b.min_time.clone(),b.max_time.clone())},e.prototype.save_state=function(){return{min_time:this.min_time.valueOf(),max_time:this.max_time.valueOf()}},e.prototype.load_state=function(a){this.update_timespan(a.min_time,a.max_time)},e.prototype.zoom=function(a,b){void 0===b&&(b=.5);var c=this.min_time.clone(),d=this.max_time.clone();if(0>a){var e=.5*this.timespan;c.subtract(e*b,"milliseconds"),d.add(e*(1-b),"milliseconds")}else{var e=.25*this.timespan;c.add(e*b,"milliseconds"),d.subtract(e*(1-b),"milliseconds")}return this.update_timespan(c,d)},e.prototype.update_timespan=function(e,f){var g=this,h=this.element,i=0;if(g._dirty=!1,g.width=h.width(),moment.isMoment(e)||(e=moment(e)),moment.isMoment(f)||(f=moment(f)),g.timespan=f.valueOf()-e.valueOf(),g.timespan<c){var j=g.min_time.valueOf()+.5*(g.max_time.valueOf()-g.min_time.valueOf());e=moment(j-.5*c),f=moment(j+.5*c),g.timespan=f.valueOf()-e.valueOf()}g.max_timespan==d&&(g.max_timespan=2*g.timespan),g.timespan>g.max_timespan&&(e=moment(g.center_time-.5*g.max_timespan),f=moment(g.center_time+.5*g.max_timespan),g.timespan=g.max_time.valueOf()-g.min_time.valueOf()),g.min_time=e,g.max_time=f;var l,m,k=g.min_time.valueOf(),n="YYYY-MM-DD",o="HH:mm",p=864e5,q=null;if(g.timespan>126144e6)p=31536e6,n="YYYY",q=null;else if(g.timespan>31536e6)p=10368e6,n="YYYY-MM",q=null;else if(g.timespan>10368e6)p=26784e5,n="YYYY-MM",q=null;else if(g.timespan>26784e5)p=26784e5,q=null;else if(g.timespan>20736e5)p=12096e5,q=null;else if(g.timespan>10368e5)p=6048e5,q=null;else if(g.timespan>=5184e5)p=864e5,q=null;else{var i,r=[2592e5,1728e5,864e5,432e5,216e5,108e5,36e5,27e5,18e5,12e5,6e5,3e5,18e4,6e4,45e3,2e4,12e3,0],s=[432e5,216e5,144e5,108e5,36e5,18e5,9e5,3e5,24e4,18e4,12e4,6e4,3e4,15e3,1e4,5e3,2e3,1e3];for(i=0;i<r.length;i++)if(g.timespan>r[i]){q=s[i];break}}l=b(p,k,g.timespan);var t=-1,u=g.ticks.children(".ec-tick"),v=g.labels.children(".ec-label,.ec-region-label"),w=0,x=0;if(null!=q)for(6e4>q&&(o="HH:mm:ss"),m=b(q,k,g.timespan),i=0;i<m.length;i++){var y=m[i],z=g.width/g.timespan*(y-k);if(w<u.length){var A=a(u[w]);A.css("left",z).css("top",1).css("height",g.items_h+1+g.markers_h),w+=1}else g.ticks.append(['<div class="ec-tick" style="left:',z,"px;top:",1,"px;height:",g.items_h+1+g.markers_h,'px;"></div>'].join(""));var B=g.width/g.timespan*(y-k),C=g.items_h+1,D=moment(y).format(o);if(B>t)if(x<v.length){var E=a(v[x]);E.css("left",B).css("top",C).text(D).removeClass("ec-region-label").addClass("ec-label"),t=B+E.width(),x+=1}else g.labels.append(['<div class="ec-label" style="left:',B,"px;top:",C,'px;">',D,"</div>"].join("")),t=B+g.labels.children(".ec-label:last-child").width()}else for(i=0;i<l.length;i++){var y=l[i],z=g.width/g.timespan*(y-k);if(w<u.length){var A=a(u[w]);A.css("left",z).css("top",1).css("height",.5*g.items_h),w+=1}else g.ticks.append(['<div class="ec-tick" style="left:',z,"px;top:",1,"px;height:",.5*g.items_h,'px;"></div>'].join(""))}for(t=-1,i=0;i<l.length;i++){var y=l[i],B=(g.width-4)/g.timespan*(y-k)+2,C=g.items_h+g.markers_h-14,D=moment(y).format(n);if(0>B)if(i<l.length-1){var F=(g.width-4)/g.timespan*(l[i+1]-k)+2;F>60&&(B=2)}else B=2;if(B>t)if(x<v.length){var E=a(v[x]);E.css("left",B).css("top",C).text(D).addClass("ec-region-label").removeClass("ec-label"),t=B+E.width(),x+=1}else g.labels.append(['<div class="ec-region-label" style="left:',B,"px;top:",C,'px;">',D,"</div>"].join("")),t=B+g.labels.children(".ec-region-label:last-child").width()}for(i=w;i<u.length;i++)a(u[i]).remove();for(i=x;i<v.length;i++)a(v[i]).remove();var G=2,H=-100,I=G,J=8,K=J+G,L=g.items.children(".ec-dot");for(i=0;i<L.length;i++){var M=a(L[i]),N=M.data("event"),O=N._starttime,P=Math.floor(G+(g.width-2*G)/g.timespan*(O-k));if(-J>P)M.css("left",-200);else if(P>g.width+J)M.css("left",g.width+200);else{var Q=P%K;P-=Q;var R=G,S=!1,z=H;J>=P+Q-H?(S=!0,P=z,R=I+K,R>g.items_h-G&&(z+=K,P=z,R=G)):I=G,S||(P+=Q),H=P,I=R,M.css("left",P).css("top",R)}}},a.fn.EventControl=function(b){return this.each(function(){var c=a(this),d=c.data("eventcontrol");if(d){if(void 0===b)return d.save_state();if("zoom-in"==b)return d.zoom.apply(d,[1]+arguments.slice(1,2));if("zoom-out"==b)return d.zoom.apply(d,[-1]+arguments.slice(1,2));d.load_state(b)}else c.data("eventcontrol",new e(c,b))})}}(jQuery);