!function(a){function b(a,b,c){var d=b-b%a,e=b+c;a>9e5&&(d-=36e5);for(var f=[d];e>d;)d+=a,d>=b&&e>=d&&f.push(d);return f.length>20&&(f=f.slice(0,20)),f}var c=1e4,d=31536e8,e=function(b,c){return this.settings=a.extend({onhover:function(a,b,c,d){},onclick:function(a,b,c){},oncreate:function(a,b){},data:[],hammertime:!1,items_height:101,markers_height:31},c),this.element=b,this.width=b.width(),this.items_h=this.settings.items_height,this.markers_h=this.settings.markers_height,this._dragging=null,this._drag_x=0,b.addClass("eventcontrol"),b.append(['<div class="ec-items ec-draggable" style="top:0px;height:',this.items_h,'px;"></div>','<div class="ec-markers ec-draggable" style="top:',this.items_h+1,"px;height:",this.markers_h,'px;">','<div class="ec-ticks"></div>','<div class="ec-labels"></div>',"</div>"].join("")),this.items=b.children(".ec-items"),this.markers=b.children(".ec-markers"),this.ticks=this.markers.children(".ec-ticks"),this.labels=this.markers.children(".ec-labels"),this.min_time=moment("2070-01-01"),this.max_time=moment("1970-01-01"),this.timespan=d,this.max_timespan=d,this.center_time=this.min_time.valueOf()+.5*d,this.init(),this};e.prototype.init=function(){function d(a,c,d){a>.9?a=.9:-.9>a&&(a=-.9);var e=a*b.timespan,f=moment(c+e),g=moment(d+e);(!f.isSame(b.min_time)||g.isSame(b.max_time))&&b.update_timespan(f,g)}function e(){c.children(".ec-draggable").removeClass("ec-dragging"),b._dragging=null}var b=this,c=this.element;b.settings.hammertime?(b.mc=new Hammer.Manager(b.element.get()[0]),b.mc.add(new Hammer.Pan),b.mc.add(new Hammer.Tap({event:"doubletap",taps:2})),b.mc.add(new Hammer.Tap({event:"singletap"})),b.mc.get("doubletap").recognizeWith("singletap"),b.mc.get("singletap").requireFailure("doubletap"),b.mc.on("panstart panleft panright singletap doubletap tap",function(e){if("singletap"==e.type){var f=a(e.target);f.hasClass("ec-dot")&&b.settings.onclick.call(b,f.data("event"),f,e)}else if("panstart"==e.type)b._pan_min_time=b.min_time.valueOf(),b._pan_max_time=b.max_time.valueOf();else if("panleft"==e.type||"panright"==e.type){var g=-e.deltaX,h=g/b.width;d(h,b._pan_min_time,b._pan_max_time)}else if("doubletap"==e.type){var i=c.offset(),j=1,k=(e.center.x-i.left)/b.width;b.zoom(j,k)}else console.log("Unexpected hammer event",e.type)})):(c.on("click",function(c){var d=a(c.target);d.hasClass("ec-dot")&&b.settings.onclick.call(b,d.data("event"),d,c)}),c.mousedown(function(a){return 1==a.which?(c.children(".ec-draggable").addClass("ec-dragging"),b._dragging=!0,b._drag_x=a.pageX,b._drag_min_time=b.min_time.valueOf(),b._drag_max_time=b.max_time.valueOf(),!1):void 0}),a("body").mouseup(function(a){1==a.which&&e()}),a("body").on("dragend",function(){e()}),a("body").mousemove(function(a){if(1==a.which&&b._dragging){var c=-(a.pageX-b._drag_x),e=c/b.width;d(e,b._drag_min_time,b.drag_max_time)}})),a(window).resize(function(){if(!b._dirty&&(b._dirty=!0,b.min_time&&b.max_time)){var a=b.min_time.clone(),c=b.max_time.clone();window.setTimeout(function(){a.isSame(b.min_time)&&c.isSame(b.max_time)&&b.update_timespan(a,c)},400)}}),c.on("mousewheel",function(a){a.preventDefault();var d=a.deltaY,e=c.offset(),f=(a.pageX-e.left)/b.width;b.zoom(d,f)}),a.each(b.settings.data,function(a,c){b.items.append('<div class="ec-dot" style="left:0px;top:0px;"></div>');var d=b.items.children(".ec-dot").last();d.data("event",c),c._starttime=moment(c.timestamp).valueOf(),b.settings.oncreate.call(b,c,d),d.hover(function(a){b.settings.onhover.call(b,c,d,a,"in")},function(a){b.settings.onhover.call(b,c,d,a,"out")});var e=moment(c.timestamp);e<b.min_time&&(b.min_time=e.clone()),e>b.max_time&&(b.max_time=e)}),b.min_time.subtract(5,"seconds"),b.max_time.add(5,"seconds"),b.center_time=b.min_time.valueOf()+.5*(b.max_time.valueOf()-b.min_time.valueOf()),b.update_timespan(b.min_time.clone(),b.max_time.clone())},e.prototype.save_state=function(){return{min_time:this.min_time.valueOf(),max_time:this.max_time.valueOf()}},e.prototype.load_state=function(a){this.update_timespan(a.min_time,a.max_time)},e.prototype.zoom=function(a,b){void 0===b&&(b=.5);var c=this.min_time.clone(),d=this.max_time.clone();if(0>a){var e=.5*this.timespan;c.subtract(e*b,"milliseconds"),d.add(e*(1-b),"milliseconds")}else{var e=.25*this.timespan;c.add(e*b,"milliseconds"),d.subtract(e*(1-b),"milliseconds")}return this.update_timespan(c,d)},e.prototype.update_timespan=function(e,f){var g=this,h=this.element;if(g._dirty=!1,g.width=h.width(),g.ticks.empty(),g.labels.empty(),moment.isMoment(e)||(e=moment(e)),moment.isMoment(f)||(f=moment(f)),g.timespan=f.valueOf()-e.valueOf(),g.timespan<c){var i=g.min_time.valueOf()+.5*(g.max_time.valueOf()-g.min_time.valueOf());e=moment(i-.5*c),f=moment(i+.5*c),g.timespan=f.valueOf()-e.valueOf()}g.max_timespan==d&&(g.max_timespan=2*g.timespan),g.timespan>g.max_timespan&&(e=moment(g.center_time-.5*g.max_timespan),f=moment(g.center_time+.5*g.max_timespan),g.timespan=g.max_time.valueOf()-g.min_time.valueOf()),g.min_time=e,g.max_time=f;var k,l,j=g.min_time.valueOf(),m="YYYY-MM-DD",n="HH:mm",o=864e5,p=null;if(g.timespan>126144e6)o=31536e6,m="YYYY",p=null;else if(g.timespan>31536e6)o=10368e6,m="YYYY-MM",p=null;else if(g.timespan>10368e6)o=26784e5,m="YYYY-MM",p=null;else if(g.timespan>26784e5)o=26784e5,p=null;else if(g.timespan>20736e5)o=12096e5,p=null;else if(g.timespan>10368e5)o=6048e5,p=null;else if(g.timespan>=5184e5)o=864e5,p=null;else{var s,q=[2592e5,1728e5,864e5,432e5,216e5,108e5,36e5,27e5,18e5,12e5,6e5,3e5,18e4,6e4,45e3,2e4,12e3,0],r=[432e5,216e5,144e5,108e5,36e5,18e5,9e5,3e5,24e4,18e4,12e4,6e4,3e4,15e3,1e4,5e3,2e3,1e3];for(s=0;s<q.length;s++)if(g.timespan>q[s]){p=r[s];break}}if(k=b(o,j,g.timespan),null!=p){6e4>p&&(n="HH:mm:ss"),l=b(p,j,g.timespan);var t=-1;a.each(l,function(a,b){var c=g.width/g.timespan*(b-j);g.ticks.append(['<div class="ec-tick" style="left:',c,"px;top:",1,"px;height:",g.items_h+1+g.markers_h,'px;"></div>'].join(""));var d=g.width/g.timespan*(b-j),e=g.items_h+1,f=moment(b).format(n);d>t&&(g.labels.append(['<div class="ec-label" style="left:',d,"px;top:",e,'px;">',f,"</div>"].join("")),t=d+g.labels.children().last().width())})}else a.each(k,function(a,b){var c=g.width/g.timespan*(b-j);g.ticks.append(['<div class="ec-tick" style="left:',c,"px;top:",1,"px;height:",.5*g.items_h,'px;"></div>'].join(""))});var t=-1;a.each(k,function(a,b){var c=(g.width-4)/g.timespan*(b-j)+2,d=g.items_h+g.markers_h-14,e=moment(b).format(m);if(0>c)if(a<k.length-1){var f=(g.width-4)/g.timespan*(k[a+1]-j)+2;f>60&&(c=2)}else c=2;c>t&&(g.labels.append(['<div class="ec-region-label" style="left:',c,"px;top:",d,'px;">',e,"</div>"].join("")),t=c+g.labels.children().last().width())});var u=2,v=-100,w=u,x=8,y=x+u;g.items.children(".ec-dot").each(function(){var b=a(this).data("event"),c=b._starttime,d=Math.floor(u+(g.width-2*u)/g.timespan*(c-j));if(-x>d)a(this).css("left",-200);else if(d>g.width+x)a(this).css("left",g.width+200);else{var e=d%y;d-=e;var f=u,h=!1,i=v;x>=d+e-v?(h=!0,d=i,f=w+y,f>g.items_h-u&&(i+=y,d=i,f=u)):w=u,h||(d+=e),v=d,w=f,a(this).css("left",d).css("top",f)}})},a.fn.EventControl=function(b){return this.each(function(){var c=a(this),d=c.data("eventcontrol");if(d){if(void 0===b)return d.save_state();if("zoom-in"==b)return d.zoom.apply(d,[1]+arguments.slice(1,2));if("zoom-out"==b)return d.zoom.apply(d,[-1]+arguments.slice(1,2));d.load_state(b)}else c.data("eventcontrol",new e(c,b))})}}(jQuery);